---
title: "algal_bloom"
author: "Tarrik Quneibi"
date: "2022-11-14"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r libraries}
library(readr)
library(rvest)
library(plotly)
library(ggplot2)
library(lubridate)
library(Amelia)
library(tidyverse)
library(Hmisc)
```

```{r}

url3 <- "https://seagull-erddap.glos.org/erddap/tabledap/obs_117.htmlTable?time%2Clongitude%2Clatitude%2Cnitrate&time%3E=2021-01-01T00%3A00%3A00Z&time%3C=2022-11-01T00%3A00%3A00Z"

wiki_url3 <- read_html(url3) # UCLA SOCR Data
df3 <- as.data.frame(html_table(html_nodes(wiki_url3, "table")[[2]]))

df3 <- df3[-1 , ]

time <- df3$time
df3 <- subset(df3, select=-c(time))
df3 <- as.data.frame(sapply(df3, as.numeric))
df3 <- cbind(time, df3)
df3$time <- ymd_hms(df3$time )

obs_data_3 <- df3[complete.cases(df3), ] %>%
  select(c("time","nitrate"))




url4 <-"https://seagull-erddap.glos.org/erddap/tabledap/obs_22.htmlTable?time%2Clongitude%2Clatitude%2Cchlorophyll_fluorescence%2Cfractional_saturation_of_oxygen_in_sea_water%2Cmass_concentration_of_blue_green_algae_in_sea_water%2Cmass_concentration_of_blue_green_algae_in_sea_water_rfu%2Cmass_concentration_of_chlorophyll_in_sea_water%2Cmass_concentration_of_oxygen_in_sea_water%2Csea_surface_temperature%2Csea_water_electrical_conductivity%2Csea_water_ph_reported_on_total_scale&time%3E=2022-07-25T00%3A00%3A00Z&time%3C=2022-11-01T00%3A00%3A00Z"
wiki_url4 <- read_html(url4) # UCLA SOCR Data
df4 <- as.data.frame(html_table(html_nodes(wiki_url4, "table")[[2]]))

df4 <- df4[-1 , ]

time <- df4$time
df4 <- subset(df4, select=-c(time))
df4 <- as.data.frame(sapply(df4, as.numeric))
df4 <- cbind(time, df4)
df4$time <- ymd_hms(df4$time )

obs_data <- inner_join(df4, obs_data_3, by='time')

url5 <- "https://seagull-erddap.glos.org/erddap/tabledap/obs_121.htmlTable?time%2Cammonia%2Cphosphate&time%3E=2022-07-25T00%3A00%3A00Z&time%3C=2022-11-01T00%3A00%3A00Z&phosphate!=NaN"
wiki_url5 <- read_html(url5) # UCLA SOCR Data
df5 <- as.data.frame(html_table(html_nodes(wiki_url5, "table")[[2]]))

df5 <- df5[-1 , ]

time <- df5$time
df5 <- subset(df5, select=-c(time))
df5 <- as.data.frame(sapply(df5, as.numeric))
df5 <- cbind(time, df5)
df5$time <- ymd_hms(df5$time )
df5$ammonia <- abs(df5$ammonia)
df5$phosphate <- abs(df5$phosphate)
df5$time <- round_date(df5$time, "10 minutes")

obs_data <- inner_join(algae_data, df5, by='time')
```

```{r data save}
write.csv(obs_data, "C:\\Users\\Tarri\\Desktop\\portfolio_projects\\algal_bloom_dashboard\\data\\algae_data.csv")



```

```{r read in data}
algae_data <- read_csv("C:\\Users\\Tarri\\Desktop\\portfolio_projects\\algal_bloom_dashboard\\data\\algae_data.csv")


```
```{r summary data}
summary(algae_data)


```





```{r missing data}
missmap(algae_data)


```

```{r data sub}
algae_sub <- algae_data %>%
  select(-c("...1","...2","time","latitude","longitude"))
headers <- c("chlorophyll_flourescence_(rfu)","oxygen_saturation_(fraction)","bluegreen_algae_conc_(ug/L)",
             "bluegreen_algae_conc_(rfu)","chlorophyll_conc_(kg/m3)","oxygen_conc_(kg/m3)","temp_(K)","elec_cond_(s/m)",
             "pH","nitrate_(ug/L)","ammonia_(ug/L)","phosphate_(ug/L)")
names(algae_sub) <- headers

```


```{r correlation}
rcorr(as.matrix(algae_sub, method="Spearman"))


```

```{r pairs plot}
set.seed(42)
algae_sub$danger_level <- ifelse(algae_sub$`bluegreen_algae_conc_(ug/L)` > 0.8 , 1, 0)
##Setting the color scale
pl_colorscale = list(c(0.0, '#119dff'),
                  c(0.5, '#119dff'),
                  c(0.5, '#ef553b'),
                  c(1, '#ef553b'))


axis = list(showline=FALSE,
            zeroline=FALSE,
            gridcolor='#ffff',
            ticklen=4,
            titlefont=list(size=13))

fig <- algae_sub %>%
  plot_ly() 
fig <- fig %>%
  add_trace(
    type = 'splom',
    dimensions = list(
      list(label='blue green algae concentration', values=~'bluegreen_algae_conc_(ug/l)'),
      list(label='chlorophyll concentration', values=~'chlorophyll_conc_(kg/m3)'),
      list(label='oxygen concentration', values=~'oxygen_conc_(kg/m3)'),
      list(label='temperature', values=~'temp_(K)'),
      list(label='electrical conductivity', values=~'elec_cond_(s/m)'),
      list(label='pH', values=~'pH'),
      list(label='nitrate', values=~'nitrate_(ug/L)'),
      list(label='ammonia', values=~'ammonia_(ug/L)'),
      list(label='phosphate', values=~'phosphate_(ug/L)')
    ),
    text=~factor(danger_level, labels=c("Low Danger","High Danger")),
    diagonal=list(visible=F),
    marker = list(
      color = ~danger_level,
      colorscale = pl_colorscale,
      size = 5,
      line = list(
        width = 1,
        color = 'rgb(230,230,230)'
      )
    )
  ) 
fig <- fig %>%
  layout(
    title = "High and low danger levels across various water quality parameters",
    hovermode='closest',
    dragmode = 'select',
    plot_bgcolor='rgba(240,240,240, 0.95)',
    xaxis=list(domain=NULL, showline=F, zeroline=F, gridcolor='#ffff', ticklen=4, titlefont=list(size=13)),
    yaxis=list(domain=NULL, showline=F, zeroline=F, gridcolor='#ffff', ticklen=4, titlefont=list(size=13)),
    xaxis2=axis,
    xaxis3=axis,
    xaxis4=axis,
    xaxis5=axis,
    xaxis6=axis,
    xaxis7=axis,
    xaxis8=axis,
    xaxis9=axis,
    yaxis2=axis,
    yaxis3=axis,
    yaxis4=axis,
    yaxis5=axis,
    yaxis6=axis,
    yaxis7=axis,
    yaxis8=axis,
    yaxis9=axis
    
  )

fig <- fig %>% style(showupperhalf = F)

fig


```